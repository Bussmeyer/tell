#!/bin/bash

BGreen='\e[1;32m'       # Green
BRed='\e[1;31m'         # Red
Color_Off='\e[0m'       # Text Reset

repo=$1

function setStatusMessage {
    printf "${IRed} --> ${BGreen}$1${Color_Off}\n" 1>&2
}

function triggerError {
    printf "${BRed} --> $1 ${Color_Off}\n" 1>&2
    exit 1
}

# Check whether a command exists
function exists {
  if command -v $1 >/dev/null 2>&1
  then
    return 0
  else
    return 1
  fi
}

function install_ansible {
    if ! exists pip; then
        setStatusMessage "Install PIP"
        sudo easy_install --quiet pip nose tornado
    fi
    if ! exists ansible; then
        setStatusMessage "Install Ansible"
        pip install --upgrade setuptools --user python
        sudo pip install -q ansible
    fi
}

function check_for_sudo {
    setStatusMessage "Checking if we need to ask for a sudo password"

    sudo -v
    export ANSIBLE_ASK_SUDO_PASS=True

    setStatusMessage "Keep-alive: update existing sudo time stamp until we are finished"
    while true; do sudo -n true; sleep 60; kill -0 "$$" || exit; done 2>/dev/null &
}

function install_ansible_roles {
    setStatusMessage "Get all the required roles"
    ansible-galaxy install -f -r requirements.yml
}

function run_ansible_playbook {
    setStatusMessage "Running the ansible playbook for your lovely macbook."
    ansible-playbook main.yml -i inventory -K
}

check_for_sudo
install_ansible
install_ansible_roles
run_ansible_playbook
